# Environmental Proxy

The essence of the sandbox is that the [Proxy](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy) introduced by ES6 opens objects in a new window, that is, the window and document accessed by the sub-application are disguised objects that has been proxied, but more favorable behaviors have been customized in response to specific needs.

The properties that are customized on the window and document objects are listed below:

## window

| Object/Method         | Behavior                                                                                                                                                                                                                                                                                  |
| --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| addEventListener      | Any registered events are automatically removed from the window when the sandbox exits.                                                                                                                                                                                                   |
| removeEventListener   | -                                                                                                                                                                                                                                                                                         |
| dispatchEvent         | Unless declared in `escapeWindowEvents`, events dispatched by default only work inside the sandbox and are not received outside.                                                                                                                                                          |
| window                | Return window proxy object, readonly.                                                                                                                                                                                                                                                     |
| self                  | Return window proxy object, readonly.                                                                                                                                                                                                                                                     |
| top                   | If the current page has no parent page, then return the window proxy object, otherwise return the real top value, readonly.                                                                                                                                                               |
| parent                | If the current page does not have a parent page, then return the window proxy object, otherwise return the real parent value, read only.                                                                                                                                                  |
| gloalThis             | Return window proxy object, readonly.                                                                                                                                                                                                                                                     |
| document              | Return document proxy object, readonly.                                                                                                                                                                                                                                                   |
| location              | Return the real location object, we proxy it because of context constraints, location is not available from the proxy.                                                                                                                                                                    |
| localStorage          | If enabled the `sandbox.patches.localStorage`, return a proxy object, the key in reading and writing are automatically pretended with the appname.<br><br>For example, under foo, `localStorage.setItem('nano')` actually writes "foo:nano"                                               |
| setTimeout            | If enabled the `sandbox.patches.setTimeout`, sandbox will automatically `clearTimeout` upon exit.                                                                                                                                                                                         |
| setInterval           | If enabled the `sandbox.patches.setInterval`, sandbox will automatically **clearInterval** upon exit.                                                                                                                                                                                     |
| XMLHttpRequest        | If enabled the `sandbox.patches.XMLHttpRequest`, sandbox will automatically **abort** upon exit.                                                                                                                                                                                          |
| MutationObserver      | If enabled the `sandbox.patches.MutationObserver`, sandbox will automatically **disconnect** upon exit.                                                                                                                                                                                   |
| requestAnimationFrame | If enabled the `sandbox.patches.requestAnimationFrame`, sandbox will automatically **cancelAnimationFrame** upon exit.<br><br>This option is only available in browser environments that support this function.                                                                           |
| requestIdleCallback   | If enabled the `sandbox.patches.requestIdleCallback`, sandbox will automatically **cancelIdleCallback** upon exit.<br><br>This option is only available in browser environments that support this function.                                                                               |
| fetch                 | If enabled the `sandbox.patches.fetch`, and the `signal` is not passed when the fetch is called, this parameter is automatically added and automatically `abort` when the sandbox exits.<br><br>This option is only effective in the browser environment that supports `AbortController`. |
| eval                  | `In planning`                                                                                                                                                                                                                                                                             |

## document

| Object/Method          | Behavior                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| addEventListener       | Any registered events are automatically removed from the document when the sandbox exits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| removeEventListener    | -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| dispatchEvent          | Unless declared in `escapeDocumentEvents`, events dispatched by default are only sent inside the sandbox and are not received externally.                                                                                                                                                                                                                                                                                                                                                                                                                |
| open                   | No effect, the console will print a warning message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| close                  | No effect, the console will print a warning message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| write                  | No effect, the console will print a warning message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| writeln                | No effect, the console will print a warning message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| replaceChildren        | No effect, the console will print a warning message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| getElementById         | Queries are limited to the application's own _&lt;haploid-html&gt;_ element and its descendants.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| getElementsByClassName | Queries are limited to the application's own _&lt;haploid-html&gt;_ element and its descendants.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| getElementsByTagName   | Same as above, but if the argument is "html", "body", "head", or "title", then the corresponding _&lt;haploid-_&gt;\* element will be returned, for example: <br>document.getElementsByTagName("html") // &lt;haploid-html&gt;<br>document.getElementsByTagName("head") // &lt;haploid-head&gt;<br>document.getElementsByTagName("title") // &lt;haploid-title&gt;<br>document.getElementsByTagName("body") // &lt;haploid-body&gt;                                                                                                                      |
| querySelector          | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| querySelectorAll       | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| getElementsByTagNameNS | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| createComment          | The following properties of the created node are redefined: <br/><ol><li>ownerDocument: the document proxy object, readonly</li><li>baseURI: baseURI of ownerDocument, readonly</li></ol>                                                                                                                                                                                                                                                                                                                                                                |
| createDocumentFragment | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| createAttribute        | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| createAttributeNS      | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| createTextNode         | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| createTextNode         | Same as above, but: <ul><li>If the argument is "script", a &lt;haploid-script&gt; element is created instead of a &lt;script&gt; element and is automatically downloaded and executed in the sandbox once inserted into &lt;haploid-head&gt;;</li><li>If the argument is "link", a &lt;haploid-link&gt; element is created instead of a &lt;link&gt; element and is automatically downloaded and takes effect in &lt;style&gt; once inserted into &lt;haploid-head&gt;; If CSS isolation is turned on, it will also be automatically converted</li></ul> |
| createElementNS        | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| defaultView            | Return window proxy object, readonly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| documentElement        | Return the _&lt;haploid-html&gt;_ element whose following attributes are redefined if the `enableHtmlPretending` is enabled:<ul><li>tagName, nodeName are all "HTML"</li><li>parentNode is document proxy object</li><li>parentElement is null</li><li>version is empty string ""</li><li>`constructor` is _HTMLHtmlElement_ </li><li>The prototype chain can be traced back to `HTMLHtmlElement.prototype` </li></ul>                                                                                                                                   |
| title                  | Returns the text content of the _&lt;haploid-title&gt;_ element, writable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| head                   | Return the above _&lt;haploid-head&gt;_ element with the following attributes redefined if the `enableHeadPretending` is enabled:<ul><li>`tagName` and `nodeName` are all "HEAD"</li><li>`constructor` is _HTMLHeadElement_</li><li>The prototype chain can be traced back to `HTMLHeadElement.prototype` </li></ul>                                                                                                                                                                                                                                     |
| body                   | Return the above _&lt;haploid-body&gt;_ element with the following attributes redefined if the `enableBodyPretending` is enabled: <ul><li>`tagName` and `nodeName` are all "BODY"</li><li>`constructor` is _HTMLBodyElement_</li><li>The prototype chain can be traced back to `HTMLBodyElement.prototype` </li></ul>                                                                                                                                                                                                                                    |
| all                    | Queries are limited to the application's own _&lt;haploid-html&gt;_ element and its descendants.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| forms                  | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| embeds                 | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| plugins                | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| images                 | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| links                  | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| styleSheets            | Same as above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| scripts                | Same as above, but queries &lt;haploid-script&gt; instead of &lt;script&gt;.                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| children               | Returns a `HTMLCollection` only includes &lt;haploid-html&gt;.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| childNodes             | Return a `NodeListOf&lt;ChildNode&gt;` only includes &lt;haploid-html&gt;.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| childElementCount      | Returns 1.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| firstElementChild      | Returns &lt;haploid-html&gt;.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| lastElementChild       | Returns &lt;haploid-html&gt;.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| dir                    | Return `dir` attribute of &lt;haploid-html&gt;, writable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| hidden                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| visibilityState        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| baseURI                | The _entry_ URL is currently returned, or the current browser page URL, will support &lt;base&gt; in the future.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| location               | Return the real `location` object, proxy it because of context constraints,location is not available from the proxy.                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| cookie                 | Returns the real `cookie` object, Proxy it because of context restrictions, cookies cannot be obtained from the proxy.                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| readyState             | Readonly, starts with "loading", changes to "interactive" before requesting sub-application CSS and JS, and becomes "complete" after requesting and executing if _readystatechange_ is declared in `autoDocumentEvents`, a change in this property triggers the _readystatechange_ event on the document proxy object, which is a local event.                                                                                                                                                                                                           |
| lastModified           | Readonly, returns the parsed date string of the **Last Modified** HTTP Header of the entry URL in standard _DD/MM/YY HH:ii:ss_ format. If there is no entry or the Header fails to be obtained, the current time is returned each time.                                                                                                                                                                                                                                                                                                                  |

::: warning
The **NodeListOf**/**HTMLAllCollection**/**HTMLCollection**/**HTMLCollectionOf**/**StyleSheetList** that may be returned by the above API is Haploid.js Simulated structures are implemented because they cannot be constructed directly with constructors. Nevertheless, the instanceof judgment condition can still be satisfied
:::

::: danger
`document.all` cannot achieve the same boolean representation as the true value, that is:

```js
typeof document.all; // get "object", but should be "undefined"
if (document.all) {
} // get truthy, but should be falsy
```

:::
